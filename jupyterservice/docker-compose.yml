### docker-compose.yml ###
## Access the jupyterlab instance at:
## https://${HOSTNAME}:8081/${PROJECTSLUG}/lab

version: "3.7"

services:
  jupyter:
    # container_name: ${PROJECTSLUG}
    image: tristanbrown/jupyterbase
    networks: 
      - caddy
    volumes:
      - ~/.ssh:/mnt/host/.ssh
      - ${PROJECT_DIR}/_Notebooks/${COMPOSE_PROJECT_NAME}:/home/jovyan/work
      - ${PROJECT_DIR}/${COMPOSE_PROJECT_NAME}:/home/jovyan/${COMPOSE_PROJECT_NAME}
    expose:
      - "8888"  ## Notebook/Lab server
      - "5000"  ## Workspace-hosted Flask server
    environment:
      - HOST_SSH_MNT=/mnt/host/.ssh
      - JUPYTERHUB_SERVICE_PREFIX=/${COMPOSE_PROJECT_NAME}/
    command: bash -c "
      . start-ssh.sh && \
      pip install -e ~/${COMPOSE_PROJECT_NAME} && \
      start-notebook.sh \
      --NotebookApp.base_url='/${COMPOSE_PROJECT_NAME}/' \
      --NotebookApp.password=${ACCESS_TOKEN} \
      --ContentsManager.allow_hidden=True"
    labels:
      caddy: localhost:8081, ${HOSTNAME}:8081
      caddy.reverse_proxy: /${COMPOSE_PROJECT_NAME}* "{{upstreams 8888}}"
      caddy.tls: "internal"
    restart: unless-stopped

networks:
  caddy:
    external: true
